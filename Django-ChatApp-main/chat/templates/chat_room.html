{% extends 'base.html' %}
{% block head %}
<style>
  .message {
    display: flex;
    margin-bottom: 10px;
  }

  .message p {
    word-break: break-all;
  }


  .input-block {
    display: block;
    /* Agrega estilos adicionales seg√∫n tus necesidades */
  }

  .message-content {
    padding: 10px;
    border-radius: 10px;
    background-color: #f0f0f0;
    overflow-y: auto;
    overflow-wrap: break-word;
  }

  .self .message-content {
    align-self: flex-end;
    background-color: #e2f3ff;
  }

  .text-left,
  .text-right {
    margin-top: auto;
  }

  .text-left {
    margin-bottom: 20px;
  }
</style>
{% endblock %}

{% block content %}

<!-- <div class="container"> -->
<div class="row justify-content-between">
  <div class="col">
    <h3>Chat Room: {{ name_to_display }}</h3>

    <div id="chatMessages" class="card mb-3" style="overflow-y: auto;height: 70vh; max-width: 800px; min-width: 800px;">
      <div class="wrapper">
        <div class="card-body" style="overflow-y: auto;">
          <div class="row" id="chatBox">
            <!-- Beginning of chat history -->
            <div class="col-2"></div>
            <div class="col-8 text-center"><a class="badge text-secondary-emphasis bg-secondary-subtle gray-900">This is
                beginning of the chat history</a></div>
            <div class="col-2"></div>
            <!-- Beginning of chat messages -->
            {% for message in chat_messages %}
            <div class="col-4 d-{% if message.sender.username == current_user %}block{%else%}none{% endif %}"></div>
            <div class="col-8">
              <div class="message mb-3 {% if message.sender.username == current_user %}self float-end{% endif %}">
                <div class="message-content">
                  <small style="font-size: 13px;">{{ message.sender.username }}</small>
                  <p class="mb-1">{{ message.message }}</p>
                  <p style="font-size: 9px;">
                    Signature:
                    <small style="font-size: 9px;">{{ message.signature }}</small>
                  </p>
                  <small style="font-size: 11px;">{{ message.timestamp }}</small>
                  <p></p>
                  <button type="button" class="btn btn-primary" onclick="decryptDiv(event)">
                    <i class="fa fa-unlock  fa-fw"></i>
                    <span class="d-none d-sm-inline"> Desencriptar</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-4 d-{% if message.sender.username == current_user %}none{%else%}block{% endif %}"></div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div class="card-footer">
      <div class="input-group input-group-sm">
        <input type="text" class="form-control" id="messageInput" placeholder="Type your message..." />
        <input type="text" class="form-control" id="keyInput" placeholder="Type your key..."/>
        <div class="input-group-append">
          <button type="button" id="sendButton" class="btn btn-primary">
            <i class="fa fa-paper-plane fa-fw"></i>
            <span class="d-none d-sm-inline"> Send</span>
          </button>
        </div>
      </div>
    </div>
  </div>


  <div class="col">
    <div id="keyAgreement" class="mb-3" style="height: 75vh; ">
      <h3>Key Sharing</h3>
      <div class="card mb-3" style="padding: 20px">
        <div>
          <h4>Public Key</h4>
          <input id="pub_key" type="text" value="" style="width: 100%;" readonly>
          <h4>Private Key</h4>
          <input id="priv_key" type="text" value="" style="width: 100%;" readonly>
          <div class="container" style="padding: 1vh;">
            <div class="row">
              <div class="col">
                <button type="button" class="btn btn-info" onclick="" id="gen_key">Generate keys and send</button>
              </div>
            </div>
          </div>
          <h3>Received Key</h3>
          <input id="shared_key" type="text" value="" style="width: 100%;" readonly>
          <h3>Final Key</h3>
          <input id="final_key" type="text" value="" style="width: 100%;" readonly>
        </div>
      </div>

    </div>
  </div>

</div>
<!-- </div> -->

{{ request.user.username|json_script:"user_username" }}
{{ room_name|json_script:"room-name" }}
<script>
  // Variables passed through template
  const roomName = JSON.parse(document.getElementById('room-name').textContent);
  const user_username = JSON.parse(document.getElementById('user_username').textContent);

  // Connect WebSocket
  const chatSocket = new WebSocket(`ws://${window.location.host}/ws/chat/${roomName}/`);

  // Receive new messages from Web Socket
  chatSocket.onmessage = function (e) {
    const message = JSON.parse(e.data);
    if (message.type == "chatroom_message") {
      document.getElementById("chatBox").innerHTML += `
        <div class="col-4 d-${message.username == user_username ? 'block' : 'none'}"></div>
          <div class="col-8">
              <div class="message mb-3 ${message.username == user_username ? 'self float-end' : ''}">
                  <div class="message-content">
                    <small style="font-size: 13px;">${message.username}</small>
                    <p class="mb-1">${message.message}</p>
                    <p style="font-size: 9px;">
                    Signature:
                    <small style="font-size: 9px;">${message.sign}</small>
                    </p>
                    <small style="font-size: 11px;">${new Date()}</small>                
                    <p></p>
                      <button type="button" class="btn btn-primary"  onclick="decryptDiv(event)">
                        <i class="fa fa-unlock fa-fw"></i>
                        <span class="d-none d-sm-inline"> Desencriptar</span>
                      </button>
                  </div>
              </div>
          </div>
        <div class="col-4 d-${message.username == user_username ? 'none' : 'block'}"></div>
      `
    }
    if (message.type == "shared_key" && message.username != user_username) {
      document.getElementById("shared_key").value = message.message

      const privKey = document.getElementById("priv_key").value

      if (privKey != '') {
        document.getElementById("final_key").value = gen_shared_key(message.message, privKey)
        document.getElementById('keyInput').value = gen_shared_key(message.message, privKey)
      }
    }

  }

  // Send Message to WebSocket
  const sendButton = document.getElementById('sendButton');
  const messageInput = document.getElementById('messageInput');
  const keyInput = document.getElementById('keyInput');

  sendButton.addEventListener('click', (event) => {
    const message = messageInput.value.trim();
    const key = keyInput.value.trim();
    if (message !== '') {
      const encryptedMessage = encript(message, key)
      // Send the message to the server
      chatSocket.send(JSON.stringify({
        'content': encryptedMessage,
        'is_key': false,
        'is_message': true,
      }));
      messageInput.value = '';
    }
  });

  const genKeyButton = document.getElementById("gen_key");
  const pubKeyText = document.getElementById('pub_key');
  const privKeyText = document.getElementById('priv_key');
  const sendKey = document.getElementById('send_key');

  genKeyButton.addEventListener('click', (event) => {
    const keys = gen_key()
    if(privKeyText.value == "" && pubKeyText.value == ""){
      pubKeyText.value = keys.pub_key
      privKeyText.value = keys.priv_key
    }

    if (pubKeyText.value != '') {
      chatSocket.send(JSON.stringify({
        'content': pubKeyText.value,
        'is_key': true,
        'is_message': false,
      }));

      const sharedKey = document.getElementById("shared_key").value

      if (sharedKey != '') {
        document.getElementById("final_key").value = gen_shared_key(sharedKey, privKeyText.value)
        document.getElementById("keyInput").value = document.getElementById("final_key").value
      }
    }
  })


</script>



{% endblock %}